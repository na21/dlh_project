# UIUC CS598 DLH Final Project

## Introduction

This repository is a reproduction study for the research paper below:

_Sun, Mengying, Tang, Fengyi, Yi, Jinfeng, Wang, Fei, & Zhou, Jiayu. Identify Susceptible Locations in Medical Records via Adversarial Attacks on Deep Predictive Models. Proceedings of the 24th ACM SIGKDD International Conference on Knowledge Discovery & Data Mining, ()._ https://doi.org/10.1145/3219819.3219909

Utilizes code from the following repositories:
* https://github.com/illidanlab/med-attack
* https://github.com/illidanlab/urgent-care-comparative
* https://github.com/MIT-LCP/mimic-code

More information may be found at:
* [**Presentation**]()
* [**Final Report**]()

## Authors

* Name: Nissan Azizov & Nivedita Chatterjee
* Email: {nazizov2, nc19}@illinois.edu

## Requirements
* Python 3.3-3.7
    * NumPy
    * Pandas
    * Gensim
    * Scikit-Learn
    * Keras
    * Tensorflow 1.10-1.15
    * Progressbar2
* PostgreSQL
* MIMIC-III Clinical Database

## Setup

Install Python requirements
```
conda create -n env-name pip
conda activate env-name
pip install -r requirements.txt
```

[Install PostgreSQL](https://www.postgresql.org/download/)

Apply for access to the [MIMIC-III Clinical Database](https://physionet.org/content/mimiciii/1.4/) and download to the root of this repository in directory ```mimic_iii_clinical_database_1.4```

## Code Usage
* **med_attack/cw.py:** Algorithm for generating adversarial examples
* **med_attack/cw_main.py:** Creates model and adversarial examples
* **urgent_care_comparative/{preprocess.py, utilities.py}:** Generates main feature tensors and time series based on data extracted from Postgres database and raw MIMIC-III files
* **sql_scripts/\*:** Scripts that create pivoted tables from raw MIMIC-III files that are necessary for preprocessing
* **mimic_code/postgres_functions.sql**: Functions that add Postgres support for some of the BigQuery syntax in sql_scripts
* **mimic_code/\*:** All necessary SQL scripts to create a local Postgres version of MIMIC-III
* **scripts/prep_files.py:** Preps files necessary for cw_main.py by creating train/test files from tensors/timeseries data generated by preprocess.py
* **archive/\*:** Code no longer used or necessary, kept for reference

## Data Preprocessing

Create MIMIC-III in a local Postgres database (db: mimic, user: postgres, password: postgres). Requiries ~100GB of space
```
(cd mimic_code && make create-user mimic datadir="../mimic_iii_clinical_database_1.4")
```

Make pivot tables
```
mkdir -p local_mimic/{views, tables, save}
psql --u postgres --d mimic

\i mimic_code/postgres_functions.sql
\i sql_scripts/pivoted_bg.sql
\i sql_scripts/pivoted_lab.sql
\i sql_scripts/pivoted_vital.sql
\i sql_scripts/icustay_detail.sql
```

Save pivot tables to csv
```
\copy (SELECT * FROM pivoted_bg) to 'local_mimic/views/pivoted_bg.csv' delimiter ',' csv header;
\copy (SELECT * FROM pivoted_lab) to 'local_mimic/views/pivoted_lab.csv' delimiter ',' csv header;
\copy (SELECT * FROM pivoted_vital) to 'local_mimic/views/pivoted_vital.csv' delimiter ',' csv header;
\copy (SELECT * FROM icustay_detail) to 'local_mimic/views/icustay_detail.csv' delimiter ',' csv header;
exit
```

Copy 3 tables from raw MIMIC data and change the column names to lowercase
```
awk 'NR==1{ print tolower($0) }NR>1' mimic_iii_clinical_database_1.4/ADMISSIONS.csv > local_mimic/tables/admissions.csv
awk 'NR==1{ print tolower($0) }NR>1' mimic_iii_clinical_database_1.4/DIAGNOSES_ICD.csv > local_mimic/tables/diagnoses_icd.csv
awk 'NR==1{ print tolower($0) }NR>1' mimic_iii_clinical_database_1.4/D_ICD_DIAGNOSES.csv > local_mimic/tables/d_icd_diagnoses.csv
```

Run urgent_care_comparative preprocessing code
```
python urgent_care_comparative/preprocess.py --path_tables local_mimic/tables --path_views local_mimic/views --path_save local_mimic/save
```

Finalize and create training/test files in 5 folds saved in directory ```processed_files/{fold_0, fold_1, etc.}```
```
python scripts/prep_files.py
```

## Training and Evaluation

Create model and adversarial examples
```
python med_attack/cw_main.py
```

A model is saved in each fold directory and an output folder containing "Adv_metric.pkl" is also generated.

Use tensorflow-gpu or tensorflow-directml (on WSL2) to utilize GPU for a 100%+ speed increase when generating the model. However, running adversarials for all 5 folds can take 4-5 days of runtime so a GPU cluster on AWS or Google Cloud is recommended.

## Results

Computing adversarial suspectability scores as done in the paper were not completed. The paper was not clear enough regarding input and general creation of these scores. However, the adversarial examples created from cw_main offer some insight.

Train/test scores for learning rate 0.02:

| Fold | Train AUC_score | Train f1 | Train PS_score | Train RC_score |
| --- | --- | --- | --- | --- |
| 0 | 0.8943 | 0.9525 | 0.9161 | 0.9918 |
| 1 | 0.8762 | 0.9506 | 0.9108 | 0.9941 |
| 2 | 0.8788 | 0.9499 | 0.9095 | 0.9941 |
| 3 | 0.8798 | 0.9531 | 0.9176 | 0.9915 |
| 4 | 0.8708 | 0.9452 | 0.8968 | 0.9991 |

| Fold | Test AUC_score | Test f1 | Test PS_score | Test RC_score |
| --- | --- | --- | --- | --- |
| 0 | 0.7932 | 0.9399 | 0.9024 | 0.9807 |
| 1 | 0.8386 | 0.9417 | 0.9012 | 0.9860 |
| 2 | 0.8347 | 0.9420 | 0.9011 | 0.9868 |
| 3 | 0.8433 | 0.9408 | 0.9050 | 0.9794 |
| 4 | 0.8292 | 0.9403 | 0.8906 | 0.9959 |